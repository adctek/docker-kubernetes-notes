# Docker Storage

## Container Image Layers

- A container image is composed of multiple layers stacked on top of each other.
- Each layer represents a specific modification to the file system (inside the container).
- Layers are immutable, meaning they can't be changed.
- The layers of a Docker image are stored in the Docker engine's cache, which ensures the efficient creation of Docker images.
- All files created inside a container are stored on a writable container layer.

Docker uses **storage drivers** to manage the contents of the image layers and the writable container layer. Each storage driver handles the implementation differently, but all drivers use stackable image layers and the copy-on-write (CoW) strategy.

The copy-on-write (CoW) strategy consist of the following:
- If a file or directory exists in a lower layer within the image, and another layer (including the writable layer) needs read access to it, it just uses the existing file
- The first time another layer needs to modify the file (when building the image or running the container), the file is copied into that layer and modified. This minimizes I/O and the size of each of the subsequent layers. 

Each layer is stored in its own directory inside the Docker host's local storage area. 

To examine the layers on the filesystem, list the contents of `/var/lib/docker/<storage-driver>`.
```bash
$ ls /var/lib/docker/overlay2

015c3c0abc18e58d3ca91f0084420d1d22628128921d402192c3adb01feb2a41
04536e862a4faf63a96d5743b4ff19047949eb3f576bb85a838b1e1fd6bd7a46
07e62d9e664608f144fed4f0c0e931dc3c526339c21c3f8c8917e847afed818d
0a05bc977ff78d0fb14283b1760b92485f1078f5c1f8e0368b0b05170311a34f
0a1d596d957e246e611d36c1f9bfde3f87716954260cbfc3606f881cadfd4a72
...
```

To check the layers that make an image:
```bash
$ docker image inspect --format "{{json .RootFS.Layers}}" simple-webapp
[
  "sha256:df64d3292fd6194b7865d7326af5255db6d81e9df29f48adde61a918fbd8c332",
  "sha256:beefb6beb20fa287cfcfaf083c0fda606f9c7f4b2830a286a50f1bbcacd52cf3",
  "sha256:67f814cf21192da3612f5a368479dbd472e678fb06b7235e1f6b8e527ef2cd8c",
  "sha256:b5e780333edd3de78d2ee5f32394a90355b3fa1ba46e69ac568a4d19e607c71c",
  "sha256:4b38e856ea3dd2d3bdccca0b8453bd8905ddec8a41b963770180845220ad326a",
  "sha256:2e9eac35d3839b276dd0699b1ff9c1389262da787869982e1c880549e492f9a1",
  "sha256:fb68dea88d522808cb0f59197aa377c336e2e176f3ed392620d40850e3eb3082"
]
```

Using `docker image history` we can also see the sizes:
```bash
$ docker imagehistory simple-webapp
IMAGE          CREATED       CREATED BY                                      SIZE      COMMENT
c6e3cd9aae36   5 years ago   /bin/sh -c #(nop)  ENTRYPOINT ["python" "app…   0B        
<missing>      5 years ago   /bin/sh -c #(nop) WORKDIR /opt                  0B        
<missing>      5 years ago   /bin/sh -c #(nop)  EXPOSE 8080                  0B        
<missing>      5 years ago   /bin/sh -c #(nop) COPY dir:1367288203bf8abdb…   30kB      
<missing>      5 years ago   /bin/sh -c pip install flask                    10.6MB    
<missing>      5 years ago   /bin/sh -c #(nop)  CMD ["python3"]              0B        
<missing>      5 years ago   /bin/sh -c set -ex;   wget -O get-pip.py 'ht…   5.92MB    
<missing>      5 years ago   /bin/sh -c #(nop)  ENV PYTHON_PIP_VERSION=18…   0B        
<missing>      6 years ago   /bin/sh -c cd /usr/local/bin  && ln -s idle3…   0B        
<missing>      6 years ago   /bin/sh -c set -ex  && apk add --no-cache --…   63.3MB    
<missing>      6 years ago   /bin/sh -c #(nop)  ENV PYTHON_VERSION=3.6.6     0B        
<missing>      6 years ago   /bin/sh -c #(nop)  ENV GPG_KEY=0D96DF4D4110E…   0B        
<missing>      6 years ago   /bin/sh -c apk add --no-cache ca-certificates   540kB     
<missing>      6 years ago   /bin/sh -c #(nop)  ENV LANG=C.UTF-8             0B        
<missing>      6 years ago   /bin/sh -c #(nop)  ENV PATH=/usr/local/bin:/…   0B        
<missing>      6 years ago   /bin/sh -c #(nop)  CMD ["/bin/sh"]              0B        
<missing>      6 years ago   /bin/sh -c #(nop) ADD file:25c10b1d1b41d46a1…   4.41MB    
```

Some steps don't have a size (0B), and are metadata-only changes, which do not produce an image layer and don't take up any size. other than the metadata itself.
The output above shows that this image consists of 6 image layers.

---

Docker has two options for containers to store files on the host machine, so that the files are persisted:
- volumes
- bind mounts

Both volumes an bind mounts can be mounted into containers using the `-v` (`--volume`) and `--mount`) flags.

## Volumes

Volumes are the preferred mechanism for persisting data generated by and used by Docker containers.

Volumes are stored in a part of the host filesystem which is managed by Docker (`/var/lib/docker/volumes/` on Linux). Non-Docker processes should not modify this part of the filesystem.

A given volume can be mounted into multiple containers simultaneously. When no running container is using a volume, the volume is still available to Docker and isn't removed automatically.

Volumes also support the use of volume drivers, which allow you to store your data on remote hosts or cloud providers, among other possibilities.

### Managing volumes

Create a volume:
```bash
$ docker volume create my-vol
```

List volumes:
```bash
$ docker volume ls

local               my-vol
```

Inspect a volume:
```bash
$ docker volume inspect my-vol
[
    {
        "Driver": "local",
        "Labels": {},
        "Mountpoint": "/var/lib/docker/volumes/my-vol/_data",
        "Name": "my-vol",
        "Options": {},
        "Scope": "local"
    }
]
```

Remove a volume:
```bash
 docker volume rm my-vol
```

Start a container with a volume using `-v` flag:
```bash
$ docker run -d --name devtest -v myvol2:/app nginx:latest
```

Start a container with a volume using `--mount` flag:
```bash
$ docker run -d --name devtest --mount source=myvol2,target=/app nginx:latest
```

To make the volume read-only:
```bash
$ docker run -d --name devtest -v myvol2:/app:ro nginx:latest
```
```bash
$ docker run -d --name devtest --mount source=myvol2,target=/app,readonly nginx:latest
```

## Bind Mounts

Bind mounts may be stored anywhere on the host system. Non-Docker processes on the Docker host or a Docker container can modify them at any time.

Bind mounts have limited functionality compared to volumes. When using a bind mount, a file or directory on the host machine is mounted into a container. The file or directory is referenced by its full path on the host machine.

Can't use Docker CLI commands to directly manage bind mounts.

To use a bind mount in a container:
```bash
$ docker run -d -it --name devtest -v "$(pwd)"/target:/app:ro nginx:latest
```
```bash
$ docker run -d -it --name devtest --mount type=bind,source="$(pwd)"/target,target=/app,readonly nginx:latest
```






